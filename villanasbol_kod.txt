import numpy as np
import cv2 as cv
import matplotlib.pyplot as plt
import time
kernel = np.ones((5,5),np.uint8)#kernel az erode-hoz
villanasok=[]

cap = cv.VideoCapture(0) #kamera
ret, frame = cap.read() #kamera képe
gray_frame_base = cv.cvtColor(frame, cv.COLOR_BGR2GRAY) #alapkép szürkébe
ret, base_frame = cv.threshold(gray_frame_base,200,255,cv.THRESH_BINARY) #alapkép thresholdolva
while(True):
    ret, frame = cap.read() #kamera képe
    gray_frame = cv.cvtColor(frame, cv.COLOR_BGR2GRAY) #kép szürkébe
    ret, frame2 = cv.threshold(gray_frame,253,255,cv.THRESH_BINARY) #kép thresholdolva
    frame_final=frame2-base_frame #alapkép kivonása, hogy az alapból benne levő fényforrások ne legyenek jelen mint zaj
    kerneled_f_frame = cv.erode(frame_final,kernel,iterations = 1) #kép erode-álása, tehát az egy-egy maradék zajpixel kivonása
    cv.imshow('frame1',kerneled_f_frame)
    frame=np.reshape(kerneled_f_frame,480*640)
    value=0
    for i in np.arange(480*640):
        if(frame[i]==255):
            value=value+1
    if(value>10):
        villanasok.append(1)
        while(True):
            time.sleep(0.1)
            ret, frame = cap.read() #kamera képe
            gray_frame = cv.cvtColor(frame, cv.COLOR_BGR2GRAY) #kép szürkébe
            ret, frame2 = cv.threshold(gray_frame,253,255,cv.THRESH_BINARY) #kép thresholdolva
            frame_final=frame2-base_frame #alapkép kivonása, hogy az alapból benne levő fényforrások ne legyenek jelen mint zaj
            kerneled_f_frame = cv.erode(frame_final,kernel,iterations = 1) #kép erode-álása, tehát az egy-egy maradék zajpixel kivonása
            frame=np.reshape(kerneled_f_frame,480*640)
            value=0
            for i in np.arange(480*640):
                if(frame[i]==255):
                    value=value+1
            if(value>10):
                villanasok.append(1)
            else: villanasok.append(0)
            if cv.waitKey(1) & 0xFF == ord('q'):
                break
    cv.imshow('frame2',kerneled_f_frame)
    if cv.waitKey(1) & 0xFF == ord('q'):
        break
        
print(kerneled_f_frame.shape)#shape->sor, oszlop
frame=np.reshape(kerneled_f_frame,480*640)
value=0
for i in np.arange(480*640):
    if(frame[i]==255):
        value=value+1

print(villanasok)
plt.imshow(kerneled_f_frame)
plt.show()
cap.release()
cv.destroyAllWindows()
